{% extends "base.html" %}

{% block title %}Adicionar Switch - Network Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Adicionar Novo Switch</h1>
        <a href="{{ url_for('web.switches') }}" class="btn btn-secondary btn-icon-split">
            <span class="icon text-white-50">
                <i class="fas fa-arrow-left"></i>
            </span>
            <span class="text">Voltar</span>
        </a>
    </div>

    <!-- Alertas de Erro -->
    <div id="formAlerts"></div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-white">Informações do Switch - Todos os Campos</h6>
        </div>
        <div class="card-body">
            <form method="POST" id="switchForm">
                <!-- Abas -->
                <ul class="nav nav-tabs" id="switchTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="identificacao-tab" data-bs-toggle="tab" href="#identificacao" role="tab">
                            <i class="fas fa-id-card"></i> Identificação
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="localizacao-tab" data-bs-toggle="tab" href="#localizacao" role="tab">
                            <i class="fas fa-map-marker-alt"></i> Localização
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tecnico-tab" data-bs-toggle="tab" href="#tecnico" role="tab">
                            <i class="fas fa-cogs"></i> Dados Técnicos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="rede-tab" data-bs-toggle="tab" href="#rede" role="tab">
                            <i class="fas fa-network-wired"></i> Rede
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="software-tab" data-bs-toggle="tab" href="#software" role="tab">
                            <i class="fas fa-code"></i> Software & Segurança
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="administrativo-tab" data-bs-toggle="tab" href="#administrativo" role="tab">
                            <i class="fas fa-file-invoice-dollar"></i> Administrativo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="controle-tab" data-bs-toggle="tab" href="#controle" role="tab">
                            <i class="fas fa-tasks"></i> Controle & Gestão
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-4" id="switchTabsContent">
                    <!-- Aba Identificação -->
                    <div class="tab-pane fade show active" id="identificacao" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="id_ativo" class="form-label">ID Ativo *</label>
                                    <input type="text" class="form-control" id="id_ativo" name="id_ativo" 
                                           required pattern="SW-\d{4}" title="Formato: SW-0001">
                                    <small class="form-text text-muted">Formato: SW-0001</small>
                                    <div class="invalid-feedback" id="id_ativo_error">
                                        Por favor, insira um ID Ativo no formato SW-0001
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="nome_switch" class="form-label">Nome do Switch *</label>
                                    <input type="text" class="form-control" id="nome_switch" name="nome_switch" required>
                                    <div class="invalid-feedback" id="nome_switch_error">
                                        Por favor, insira o nome do switch
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="status_funcionamento" class="form-label">Status *</label>
                                    <select class="form-control" id="status_funcionamento" name="status_funcionamento" required>
                                        <option value="">Selecione...</option>
                                        <option value="Em produção">Em produção</option>
                                        <option value="Inativo (Manutenção)">Inativo (Manutenção)</option>
                                        <option value="Em teste">Em teste</option>
                                        <option value="Desativado">Desativado</option>
                                    </select>
                                    <div class="invalid-feedback" id="status_funcionamento_error">
                                        Por favor, selecione o status do switch
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="criticidade" class="form-label">Criticidade *</label>
                                    <select class="form-control" id="criticidade" name="criticidade" required>
                                        <option value="">Selecione...</option>
                                        <option value="Alta">Alta</option>
                                        <option value="Média">Média</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                    <div class="invalid-feedback" id="criticidade_error">
                                        Por favor, selecione a criticidade
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="ambiente" class="form-label">Ambiente *</label>
                                    <select class="form-control" id="ambiente" name="ambiente" required>
                                        <option value="">Selecione...</option>
                                        <option value="Produção">Produção</option>
                                        <option value="Teste">Teste</option>
                                        <option value="Desenvolvimento">Desenvolvimento</option>
                                    </select>
                                    <div class="invalid-feedback" id="ambiente_error">
                                        Por favor, selecione o ambiente
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Localização -->
                    <div class="tab-pane fade" id="localizacao" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="unidade" class="form-label">Unidade *</label>
                                    <input type="text" class="form-control" id="unidade" name="unidade" required>
                                    <div class="invalid-feedback" id="unidade_error">
                                        Por favor, insira a unidade
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="local_detalhado" class="form-label">Local Detalhado</label>
                                    <input type="text" class="form-control" id="local_detalhado" name="local_detalhado">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="rack" class="form-label">Rack</label>
                                    <input type="text" class="form-control" id="rack" name="rack">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="posicao_u" class="form-label">Posição U</label>
                                    <input type="text" class="form-control" id="posicao_u" name="posicao_u">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="ponto_referencia" class="form-label">Ponto de Referência</label>
                                    <input type="text" class="form-control" id="ponto_referencia" name="ponto_referencia">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Dados Técnicos -->
                    <div class="tab-pane fade" id="tecnico" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="fabricante" class="form-label">Fabricante *</label>
                                    <select class="form-control" id="fabricante" name="fabricante" required onchange="toggleCustomFabricante()">
                                        <option value="">Selecione...</option>
                                        <option value="Cisco">Cisco</option>
                                        <option value="HP">HP</option>
                                        <option value="Aruba">Aruba</option>
                                        <option value="Dell">Dell</option>
                                        <option value="Juniper">Juniper</option>
                                        <option value="Extreme Networks">Extreme Networks</option>
                                        <option value="Brocade">Brocade</option>
                                        <option value="MikroTik">MikroTik</option>
                                        <option value="Ubiquiti">Ubiquiti</option>
                                        <option value="Outro">Outro (especificar)</option>
                                    </select>
                                    <div class="invalid-feedback" id="fabricante_error">
                                        Por favor, selecione o fabricante
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="modelo" class="form-label">Modelo *</label>
                                    <input type="text" class="form-control" id="modelo" name="modelo" required>
                                    <div class="invalid-feedback" id="modelo_error">
                                        Por favor, insira o modelo do switch
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="customFabricante" class="row" style="display: none;">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="fabricante_custom" class="form-label">Especificar Fabricante *</label>
                                    <input type="text" class="form-control" id="fabricante_custom" name="fabricante_custom">
                                    <div class="invalid-feedback" id="fabricante_custom_error">
                                        Por favor, especifique o fabricante
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Restante do código da aba técnica permanece igual -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="numero_serie" class="form-label">Número de Série</label>
                                    <input type="text" class="form-control" id="numero_serie" name="numero_serie">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="tipo_switch" class="form-label">Tipo de Switch</label>
                                    <select class="form-control" id="tipo_switch" name="tipo_switch">
                                        <option value="Core">Core</option>
                                        <option value="Acesso">Acesso</option>
                                        <option value="Distribuição">Distribuição</option>
                                        <option value="Aggregation">Aggregation</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ... (restante dos campos técnicos) -->
                    </div>

                    <!-- ... (outras abas permanecem iguais) -->

                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-icon-split">
                        <span class="icon text-white-50">
                            <i class="fas fa-save"></i>
                        </span>
                        <span class="text">Salvar Switch</span>
                    </button>
                    <a href="{{ url_for('web.switches') }}" class="btn btn-secondary ml-2">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCustomFabricante() {
    const fabricante = document.getElementById('fabricante').value;
    const customDiv = document.getElementById('customFabricante');
    const customInput = document.getElementById('fabricante_custom');
    
    if (fabricante === 'Outro') {
        customDiv.style.display = 'block';
        customInput.required = true;
    } else {
        customDiv.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
}

// Sistema de validação avançada
document.getElementById('switchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Limpar alertas anteriores
    clearAlerts();
    clearValidation();
    
    // Validar campos obrigatórios
    const errors = validateForm();
    
    if (errors.length > 0) {
        showValidationErrors(errors);
        return false;
    }
    
    // Se passou na validação, enviar formulário
    this.submit();
});

function validateForm() {
    const errors = [];
    const requiredFields = [
        'id_ativo', 'nome_switch', 'status_funcionamento', 'criticidade', 
        'ambiente', 'unidade', 'fabricante', 'modelo'
    ];
    
    // Validar campos obrigatórios
    requiredFields.forEach(field => {
        const element = document.getElementById(field);
        if (!element.value.trim()) {
            errors.push({
                field: field,
                message: `O campo ${getFieldName(field)} é obrigatório`
            });
        }
    });
    
    // Validar formato do ID Ativo
    const idAtivo = document.getElementById('id_ativo').value;
    if (idAtivo && !/^SW-\d{4}$/.test(idAtivo)) {
        errors.push({
            field: 'id_ativo',
            message: 'ID Ativo deve estar no formato SW-0001'
        });
    }
    
    // Validar fabricante customizado
    const fabricante = document.getElementById('fabricante').value;
    if (fabricante === 'Outro') {
        const customFabricante = document.getElementById('fabricante_custom').value;
        if (!customFabricante.trim()) {
            errors.push({
                field: 'fabricante_custom',
                message: 'Por favor, especifique o fabricante'
            });
        }
    }
    
    return errors;
}

function getFieldName(fieldId) {
    const fieldNames = {
        'id_ativo': 'ID Ativo',
        'nome_switch': 'Nome do Switch',
        'status_funcionamento': 'Status',
        'criticidade': 'Criticidade',
        'ambiente': 'Ambiente',
        'unidade': 'Unidade',
        'fabricante': 'Fabricante',
        'modelo': 'Modelo',
        'fabricante_custom': 'Fabricante (custom)'
    };
    return fieldNames[fieldId] || fieldId;
}

function showValidationErrors(errors) {
    const alertsContainer = document.getElementById('formAlerts');
    
    // Criar alerta principal
    const mainAlert = document.createElement('div');
    mainAlert.className = 'alert alert-danger alert-dismissible fade show';
    mainAlert.innerHTML = `
        <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro de Validação</h6>
        <p>Por favor, corrija os seguintes campos:</p>
        <ul>
            ${errors.map(error => `<li><strong>${getFieldName(error.field)}:</strong> ${error.message}</li>`).join('')}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(mainAlert);
    
    // Destacar campos com erro
    errors.forEach(error => {
        const field = document.getElementById(error.field);
        const errorElement = document.getElementById(`${error.field}_error`);
        
        if (field) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.style.display = 'block';
                errorElement.textContent = error.message;
            }
        }
        
        // Navegar para a aba do campo com erro
        if (field) {
            const tab = findTabForField(error.field);
            if (tab) {
                const tabElement = document.querySelector(`[href="#${tab}"]`);
                if (tabElement) {
                    new bootstrap.Tab(tabElement).show();
                }
            }
        }
    });
    
    // Scroll para o topo para ver o alerta
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function findTabForField(fieldId) {
    const fieldToTabMap = {
        'id_ativo': 'identificacao',
        'nome_switch': 'identificacao',
        'status_funcionamento': 'identificacao',
        'criticidade': 'identificacao',
        'ambiente': 'identificacao',
        'unidade': 'localizacao',
        'local_detalhado': 'localizacao',
        'rack': 'localizacao',
        'posicao_u': 'localizacao',
        'ponto_referencia': 'localizacao',
        'fabricante': 'tecnico',
        'fabricante_custom': 'tecnico',
        'modelo': 'tecnico',
        'numero_serie': 'tecnico',
        'tipo_switch': 'tecnico'
        // Adicione mais mapeamentos conforme necessário
    };
    return fieldToTabMap[fieldId];
}

function clearAlerts() {
    const alertsContainer = document.getElementById('formAlerts');
    alertsContainer.innerHTML = '';
}

function clearValidation() {
    // Remover classes de erro de todos os campos
    const fields = document.querySelectorAll('.is-invalid');
    fields.forEach(field => field.classList.remove('is-invalid'));
    
    // Esconder mensagens de erro
    const errorMessages = document.querySelectorAll('.invalid-feedback');
    errorMessages.forEach(msg => msg.style.display = 'none');
}

// Validação em tempo real
document.addEventListener('DOMContentLoaded', function() {
    toggleCustomFabricante();
    
    // Validar campos enquanto o usuário digita
    const fields = document.querySelectorAll('input[required], select[required]');
    fields.forEach(field => {
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
    
    // Validação específica para ID Ativo
    const idAtivoField = document.getElementById('id_ativo');
    if (idAtivoField) {
        idAtivoField.addEventListener('blur', function() {
            if (this.value && !/^SW-\d{4}$/.test(this.value)) {
                this.classList.add('is-invalid');
                document.getElementById('id_ativo_error').textContent = 'Formato inválido. Use SW-0001';
                document.getElementById('id_ativo_error').style.display = 'block';
            }
        });
    }
});
</script>

<style>
.invalid-feedback {
    display: none;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.alert ul {
    margin-bottom: 0;
}

.alert li {
    margin: 0.25rem 0;
}
</style>
{% endblock %}